context("reprex")

test_that("Render character vectors", {
  single <- "hello, world!"
  expect_equivalent(clipr::write_clip(single), single)
})

out <- c("``` r", "1:5", "#> [1] 1 2 3 4 5", "```")

test_that("clipboard input works", {
  clipr::write_clip("1:5")
  cat(clipr::read_clip())
  ret <- reprex(show = FALSE)
  cat(ret, sep = "\n")
  cat(out, sep = "\n")
  expect_identical(ret, out)
})

test_that("expression input works", {
  ret <- reprex(1:5, show = FALSE)
  expect_identical(ret, out)
})

test_that("file input works", {
  write("1:5", "foo.R")
  ret <- reprex(infile = "foo.R", show = FALSE)
  expect_identical(ret, out)
  file.remove("foo.R")
})

test_that("can't see environment of caller", {
  z <- "don't touch me"
  ret <- reprex(paste0(z, "!!!"), show = FALSE)
  expect_match(ret, "object 'z' not found", all = FALSE)
})

test_that("expression input is not evaluated in environment of caller", {
  z <- "don't touch me"
  reprex(z <- "I touched it", show = FALSE)
  expect_identical(z, "don't touch me")
})

test_that("reprex doesn't write into environment of caller", {
  z <- "don't touch me"
  ret <- reprex((z <- "I touched it!"), show = FALSE)
  expect_identical(ret[3], "#> [1] \"I touched it!\"")
  expect_identical(z, "don't touch me")

  ## concrete example I have suffered from:
  ## assign object to name of object inside reprex_()
  expect_match(reprex(r_file <- 0L, show = FALSE), "r_file <- 0L", all = FALSE)

})

test_that("The si = TRUE option adds session info line", {
  ret <- reprex(y <- 2, show = FALSE, si = TRUE)
  expect_true(any(ret %in% c("devtools::session_info()", "sessionInfo()")))
})

test_that("Circular use is detected before render", {
  ret <- reprex(y <- 2, show = FALSE)
  cat(clipr::read_clip())
  expect_error(reprex(show = FALSE), "isn't valid R code")
})
